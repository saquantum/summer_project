<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>WebSocket Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
<div id="app">
    <!-- overlay popup component -->
    <div v-show="hasNotification" id="modal-overlay">
        <div id="modal">
            <p>{{popupNotification}}</p>
            <button class="submit" @click="unsubscribe">unsubscribe</button>
            <button class="submit" @click="hasNotification = false">close</button>
        </div>
    </div>
    <!-- sidebar component -->
    <div class="sidebar">
        <div>
            <a href="/">
                <img src="../images/uob.webp" id="logo" alt="logo">
            </a>
        </div>
        <button v-if="isAdminAccessing" @click="goBackToAdminDashboard" :class="{ active: sidebarActive === 'admin' }">
            Admin Dashboard
        </button>
        <button @click="sidebarActive = 'profile'" :class="{ active: sidebarActive === 'profile' }">My Profile</button>
        <button @click="sidebarActive = 'allAssets'" :class="{ active: sidebarActive === 'allAssets' }">My Assets
        </button>
        <button v-show="sidebarActive === 'currentAsset'" @click="sidebarActive = 'currentAsset'"
                :class="{ active: sidebarActive === 'currentAsset' }">Current Asset
        </button>
    </div>
    <!-- main contents -->
    <div class="main">
        <!-- user profile -->
        <div v-if="sidebarActive === 'profile'" class="topbar"></div>
        <div v-if="sidebarActive === 'profile'" class="content"></div>
        <!-- user assets -->

        <div v-if="sidebarActive === 'allAssets'" class="topbar">
            <h3>
                {{isAdminAccessing ? (currentUserId <= 0 ? 'Admin ( no user selected )' : `Admin ( as user ${currentUserId} )`) : 'My Assets'}}</h3>
            <div style="flex-grow: 1;"></div>
            <input type="text" name="assetName" placeholder="Search my asset">
            <select name="alert">
                <option value="" selected disabled>Select Warning Level</option>
                <option value="no">No Warning</option>
                <option value="yellow">Yellow Warning</option>
                <option value="amber">Amber Warning</option>
                <option value="red">Red Warning</option>
            </select>
            <select name="county">
                <option value="" selected disabled>Select County of Asset</option>
                <option value="london">Greater London</option>
                <option value="bristol">Bristol</option>
            </select>
            <div style="flex-grow: 1;"></div>
            <a href="/admin"><img src="../images/mailbox.png" alt="mailbox" class="mailbox-icon"></a>
        </div>
        <div v-if="sidebarActive === 'allAssets'" class="content">
            <div class="assets-grid-container">
                <div class="asset-card" v-for="(item, index) in currentUsersAllAssets" :key="index">
                    <div :id="'map-' + index" class="mini-map"></div>
                    <h4 style="text-align: center;">
                        <a @click="switch2CurrentAsset(index)"
                           style="color: blue;text-decoration: underline;cursor: pointer;">
                            {{ item.name }}
                        </a>
                    </h4>
                </div>
            </div>
        </div>
        <!-- current asset -->

        <div v-if="sidebarActive === 'currentAsset'" class="topbar">
            <h3>{{currentAsset.name}}</h3>
            <div style="flex-grow: 1;"></div>
            <a href="/admin"><img src="../images/mailbox.png" alt="mailbox" class="mailbox-icon"></a>
        </div>
        <div v-if="sidebarActive === 'currentAsset'" class="content">
            <div class="asset-detail-container">
                <div id="map" style="height: 500px; grid-column: 1 / span 2;">
                </div>
                <div>
                    <button class="submit" style="display: block"
                            title="Will reset contact details of this asset to align with your default profile settings.">
                        Reset All
                    </button>
                    <p class="short-p" style="display: block">Contact preference for this asset</p>
                    <select name="contactPreference" v-model="selectedContact">
                        <option v-for="option in contactOptions" :value="option.value">
                            {{ option.label }}
                        </option>
                    </select>
                    <p class="short-p">{{ getSelectedOption().desc}}:</p>
                    <input
                            type="text"
                            :placeholder="getSelectedOption().placeholder"
                            name="atesaki"
                    />
                    <p class="short-p" style="display: block"></p>
                    <button class="submit" style="display: block">Save</button>
                    <p class="short-p" style="display: block"></p>
                    <button v-if="!currentAsset.unsubscribe" @click="toggleSubscribe" style="display: block"
                            class="submit"
                            title="Will unsubscribe all warnings on this asset. Will not remove this asset from your assets.">
                        Unsubscribe this asset
                    </button>
                    <button v-else @click="toggleSubscribe" style="display: block" class="submit">Subscribe this asset
                    </button>
                </div>
            </div>
            <div>
                <p style="display: block">
                    Current warning on this asset: none
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    const app = new Vue({
        el: '#app',
        data: {
            sidebarActive: 'allAssets',
            stompClient: null,
            hasNotification: false,
            popupNotification: null,
            editingId: null,
            hasFoundAsset: false,
            isAdminAccessing: false,
            currentUserId: null,
            currentUsersAllAssets: [],
            currentAsset: null,
            map: null,
            geoLayer: null,
            hasPersonalInfo: false,
            holderInfo: null,
            contactOptions: [
                {value: 'email', label: 'Email', desc: 'Send email to this address', placeholder: 'email address'},
                {value: 'sms', label: 'SMS', desc: 'Send SMS to this phone number', placeholder: 'phone number'},
                {
                    value: 'discord',
                    label: 'Discord',
                    desc: 'Send to this Discord account',
                    placeholder: 'Discord account'
                },
                {
                    value: 'whatsapp',
                    label: 'WhatsApp',
                    desc: 'Send to this WhatsApp account',
                    placeholder: 'WhatsApp account'
                },
                {
                    value: 'telegram',
                    label: 'Telegram',
                    desc: 'Send to this Telegram account',
                    placeholder: 'Telegram account'
                }
            ],
            selectedContact: 'email',
        },
        methods: {
            switch2CurrentAsset(index) {
                console.log('switch2CurrentAsset');
                this.sidebarActive = 'currentAsset';
                this.currentAsset = this.currentUsersAllAssets[index];
                this.$nextTick(() => {
                    const geojson = this.currentAsset.drainArea;
                    this.displayMap(geojson);
                });
            },
            toggleSubscribe() {
                if (typeof this.currentAsset.unsubscribe !== 'boolean') {
                    this.$set(this.currentAsset, 'unsubscribe', true);
                } else {
                    this.currentAsset.unsubscribe = !this.currentAsset.unsubscribe;
                }
                console.log(this.currentAsset.unsubscribe);
            },
            // https://leafletjs.com/examples/geojson/
            displayMap(geojson) {
                if (this.map) {
                    this.map.remove();
                    this.map = null;
                }
                this.$nextTick(() => {
                    this.map = L.map('map').setView([0, 0], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(this.map);

                    if (this.geoLayer) {
                        this.geoLayer.remove();
                    }

                    this.geoLayer = L.geoJSON(geojson).addTo(this.map);
                    this.map.fitBounds(this.geoLayer.getBounds());
                });
            },
            async findPersonalInfo() {
                const response = await fetch(`/user/api/holder/${this.asset.assetHolderId}`, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                });
                this.holderInfo = (await response.json()).data[0];
                this.hasPersonalInfo = true;
            },
            async updatePersonalInfo() {
                //if(this.holderInfo.name === "" || this.holderInfo.phone === "" || this.holderInfo.email === "" || this.holderInfo.contactPreference === "") return;
                const body = JSON.stringify(this.holderInfo);
                console.log(body)
                const response = await fetch(`/user/api/holder/`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: body
                });
            },
            async unsubscribe() {
                if (this.subscription) {
                    this.subscription.unsubscribe();
                    this.subscription = null;
                }
                this.hasNotification = false;
            },
            async loadAllAssets() {
                const response = await fetch(`/user/api/holder/${this.currentUserId}/asset/`, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                });
                this.currentUsersAllAssets = (await response.json()).data;

                this.$nextTick(() => {
                    this.currentUsersAllAssets.forEach((asset, index) => {
                        const map = L.map('map-' + index).setView([0, 0], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(map);
                        const geoLayer = L.geoJSON(asset.drainArea).addTo(map);
                        map.fitBounds(geoLayer.getBounds());
                    });
                });
            },
            getSelectedOption() {
                return this.contactOptions.find(o => o.value === this.selectedContact);
            },
            async goBackToAdminDashboard() {
                await fetch(`/admin/api/as/clear`, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                });
                window.location.href = '/admin/';
            }
        },
        watch: {
            sidebarActive(newVal) {
                if (newVal === 'allAssets') {
                    this.loadAllAssets();
                }
            }
        },
        async mounted() {
            const socket = new SockJS('/ws')
            this.stompClient = Stomp.over(socket);
            this.stompClient.connect({}, () => {
                this.subscription = this.stompClient.subscribe('/topic/notify', (msg) => {
                    this.popupNotification = msg.body;
                    this.hasNotification = true;
                });
            });

            if (this.sidebarActive === 'allAssets') {
                const response = await fetch('/user/api/me', {
                    method: 'GET',
                    credentials: 'include'
                });
                const info = await response.json();
                this.isAdminAccessing = info.data.isAdmin;
                this.currentUserId = info.data.id;
                if (this.currentUserId <= 0) return;
                await this.loadAllAssets();
            }
        },
        beforeDestroy() {
            if (this.stompClient) {
                this.stompClient.deactivate()
            }
        },
    })
</script>
</body>
</html>