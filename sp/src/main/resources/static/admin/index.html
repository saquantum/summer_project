<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Admin Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
<div id="app">
    <!-- overlay popup component -->
    <div v-show="hasNotification" id="modal-overlay">
        <div id="modal">
            <p>{{popupNotification}}</p>
            <button class="submit" @click="hasNotification = false">close</button>
        </div>
    </div>
    <!-- sidebar component -->
    <div class="sidebar">
        <div>
            <a href="/">
                <img src="../images/uob.webp" id="logo" alt="logo">
            </a>
        </div>
        <button @click="setSideBar('test')" :class="{ active: sidebarActive === 'test' }">Send Notifications
        </button>
        <button @click="setSideBar('users')" :class="{ active: sidebarActive === 'users' }">All Users</button>
        <button @click="setSideBar('assets')" :class="{ active: sidebarActive === 'assets' }">All Assets</button>
        <button @click="setSideBar('warnings')" :class="{ active: sidebarActive === 'warnings' }">All Warnings
        </button>
        <button v-show="sidebarActive === 'currentWarning'" @click="setSideBar('currentWarning')"
                :class="{ active: sidebarActive === 'currentWarning' }">Current Warning
        </button>
    </div>
    <!-- main -->
    <div class="main">
        <div class="topbar">
            <h3>Admin Interface</h3>
        </div>
        <div v-if="sidebarActive === 'test'" class="content">
            <div>
                <input type="text" v-model="notification"/>
                <button class="submit" @click="sendNotification">send</button>
            </div>
        </div>
        <div v-if="sidebarActive === 'users'" class="content">
            <div v-if="allAssetHolders.length > 0">
                <table>
                    <thead>
                    <tr>
                        <th>UID</th>
                        <th>AssetHolderID</th>
                        <th>Username</th>
                        <th>#Assets</th>
                        <th>Performable Actions(You should not see this)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="(item, index) in allAssetHolders" :key="index">
                        <td>{{item.user.id}}</td>
                        <td>{{item.assetHolder.id}}</td>
                        <td>{{item.user.username}}</td>
                        <td>{{item.assetCount}}</td>
                        <td>
                            <div>
                                <button class="submit" @click.stop="gotoUser(index)">goto</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div v-if="sidebarActive === 'assets'" class="content">
            <div v-if="allAssets.length > 0">
                <table>
                    <thead>
                    <tr>
                        <th>Asset ID</th>
                        <th>Asset Name</th>
                        <th>Asset Holder ID</th>
                        <th>Warning Level</th>
                        <th>Performable Actions(You should not see this)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="(item, index) in allAssets" :key="index">
                        <td>{{item.asset.id}}</td>
                        <td>{{item.asset.name}}</td>
                        <td>{{item.asset.assetHolderId}}</td>
                        <td :style="getWarningStyle(findHighestLevel(item.warnings))">
                            {{ findHighestLevel(item.warnings) }}
                        </td>
                        <td>
                            <div>
                                <button class="submit" @click.stop="gotoAsset(index)">goto</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div v-if="sidebarActive === 'warnings'" class="content">
            <div id="allWarningsMap" style="height: 500px; width: 50vw;"></div>
            <div v-if="allWarnings.length > 0">
                <table>
                    <thead>
                    <tr>
                        <th>Warning ID</th>
                        <th>Weather Type</th>
                        <th>Warning Level</th>
                        <th>Warning Impact</th>
                        <th>Warning Likelihood</th>
                        <th>Valid From</th>
                        <th>Valid To</th>
                        <th>Performable Actions(You should not see this)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="(item, index) in allWarnings" :key="index">
                        <td>{{item.id}}</td>
                        <td>{{item.weatherType}}</td>
                        <td>{{item.warningLevel}}</td>
                        <td>{{item.warningImpact}}</td>
                        <td>{{item.warningLikelihood}}</td>
                        <td>{{new Date(item.validFrom * 1000).toLocaleString()}}</td>
                        <td>{{new Date(item.validTo * 1000).toLocaleString()}}</td>
                        <td>
                            <div>
                                <button class="submit" @click.stop="gotoWarning(index)">goto</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div v-if="sidebarActive === 'currentWarning'" class="content">
            <div id="warningMap" style="height: 500px; width: 50vw;"></div>
            <table>
                <tbody>
                <tr>
                    <td>Warning ID</td>
                    <td>{{currentWarning.id}}</td>
                </tr>
                <tr>
                    <td>Weather Type</td>
                    <td>{{currentWarning.weatherType}}</td>
                </tr>
                <tr>
                    <td>Warning Level</td>
                    <td>{{currentWarning.warningLevel}}</td>
                </tr>
                <tr>
                    <td>Warning HeadLine</td>
                    <td>{{currentWarning.warningHeadLine}}</td>
                </tr>
                <tr>
                    <td>Valid From</td>
                    <td>{{new Date(currentWarning.validFrom * 1000).toLocaleString()}}</td>
                </tr>
                <tr>
                    <td>Valid To</td>
                    <td>{{new Date(currentWarning.validTo * 1000).toLocaleString()}}</td>
                </tr>
                <tr>
                    <td>Warning Impact</td>
                    <td>{{currentWarning.warningImpact}}</td>
                </tr>
                <tr>
                    <td>Warning Likelihood</td>
                    <td>{{currentWarning.warningLikelihood}}</td>
                </tr>
                <tr>
                    <td>Affected Areas</td>
                    <td v-html="currentWarning.affectedAreas.replaceAll('\\n', '<br>')"></td>
                </tr>
                <tr>
                    <td>Further Details</td>
                    <td v-html="currentWarning.affectedAreas.replaceAll('\\n', '<br>')"></td>
                </tr>
                <tr>
                    <td>Update Description</td>
                    <td>{{currentWarning.warningUpdateDescription}}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    const app = new Vue({
        el: '#app',
        data: {
            notification: "",
            hasNotification: false,
            popupNotification: null,
            asUserId: '',
            sidebarActive: 'test',
            allAssets: [],
            allAssetHolders: [],
            allWarnings: [],
            currentWarning: null,
            maps: [],
        },
        methods: {
            async sendNotification() {
                const body = {"message": this.notification};
                const response = await fetch(`/admin/api/notify`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(body),
                });
            },
            async proxyAsUser() {
                await fetch(`/admin/api/as/${this.asUserId}`, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                });
                window.location.href = '/user/';
            },
            async gotoUser(index) {
                this.asUserId = this.allAssetHolders[index].assetHolder.id;
                await this.proxyAsUser();
            },
            async proxyAsUserInAsset(assetID) {
                await fetch(`/admin/api/as/${this.asUserId}/inAsset/${assetID}`, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                });
                window.location.href = '/user/';
            },
            async gotoAsset(index) {
                this.asUserId = this.allAssets[index].asset.assetHolderId;
                await this.proxyAsUserInAsset(this.allAssets[index].asset.id);
            },
            async loadAllUsers() {
                const response = await fetch(`/user/api/holder`, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                });
                this.allAssetHolders = (await response.json()).data;
            },
            async loadAllAssets() {
                const response = await fetch(`/user/api/asset`, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                });
                this.allAssets = (await response.json()).data;
            },
            async loadAllWarnings() {
                const response = await fetch(`/user/api/warning`, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                });
                this.allWarnings = (await response.json()).data;
                this.displayMap('allWarningsMap', this.allWarnings.map(w => {
                    let geoJson = w.polygon;
                    geoJson.style = this.setWarningLevelStyle(w.warningLevel);
                    return geoJson;
                }));
            },
            findHighestLevel(list) {
                if (list.length === 0) return "none";
                let max = 'yellow';
                for (const w of list) {
                    const warning = w.warningLevel.toLowerCase();
                    if (warning.includes('red')) {
                        max = 'red';
                        break;
                    }
                    if (warning.includes('amber')) {
                        max = 'amber';
                    }
                }
                return max;
            },
            getWarningStyle(level) {
                switch (level.toLowerCase()) {
                    case 'red':
                        return 'background-color: #C32030; color: white;';
                    case 'amber':
                        return 'background-color: #F28C28; color: black;';
                    case 'yellow':
                        return 'background-color: #F9E11C; color: black;';
                    default:
                        return '';
                }
            },
            gotoWarning(index) {
                this.currentWarning = this.allWarnings[index];
                this.setSideBar('currentWarning');
                if (this.map) {
                    this.map.remove();
                    this.map = null;
                }
                this.$nextTick(() => {
                    this.currentWarning.polygon.style = this.setWarningLevelStyle(this.currentWarning.warningLevel)
                    this.displayMap('warningMap', this.currentWarning.polygon);
                });
            },
            setWarningLevelStyle(level) {
                let style = {weight: 2, fillOpacity: 0.4};
                if (level) {
                    if (level.toLowerCase().includes('yellow')) {
                        style.color = '#cc9900';
                        style.fillColor = '#ffff00'
                    }
                    if (level.toLowerCase().includes('amber')) {
                        style.color = '#cc6600';
                        style.fillColor = '#ffcc00'
                    }
                    if (level.toLowerCase().includes('red')) {
                        style.color = '#800000';
                        style.fillColor = '#ff0000'
                    }
                }
                return style;
            },
            displayMap(tagID, geoJson) {
                this.$nextTick(() => {
                    const map = L.map(tagID).setView([0, 0], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);
                    const geoArray = Array.isArray(geoJson) ? geoJson : [geoJson];
                    const geoLayer = L.geoJSON(geoArray, {style: feature => feature.geometry.style}).addTo(map);
                    map.fitBounds(geoLayer.getBounds());
                    this.maps.push(map);
                });
            },
            cleanMaps() {
                if (this.maps.length > 0) {
                    this.maps.forEach(map => {
                        map.eachLayer(layer => {
                            if (!(layer instanceof L.TileLayer)) {
                                map.removeLayer(layer);
                            }
                        });
                        const container = map.getContainer();
                        map.remove();
                        if (container && container._leaflet_id) {
                            container.innerHTML = '';
                            container._leaflet_id = null;
                        }
                    });
                    this.maps = [];
                }
            },
            setSideBar(newState) {
                if(this.sidebarActive === newState) return;
                this.cleanMaps();
                this.sidebarActive = newState;
            },
        },
        watch: {
            sidebarActive: {
                immediate: true,
                async handler(newVal) {
                    if (newVal === 'assets') {
                        await this.loadAllAssets();
                    }
                    if (newVal === 'users') {
                        await this.loadAllUsers();
                    }
                    if (newVal === 'warnings') {
                        await this.loadAllWarnings();
                    }
                },
            }
        },
    })
</script>
</body>
</html>